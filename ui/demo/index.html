<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        background: black;
        font-family: Arial, Helvetica, sans-serif;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body class="sl-theme-dark">
    <profiles-test style="height: 100%; display: flex"></profiles-test>

    <script type="module">
      import "@shoelace-style/shoelace/dist/themes/dark.css";

      import { AppAgentWebsocket } from "@holochain/client";
      import { decode } from "@msgpack/msgpack";
      import { LitElement, html } from "lit";
      import { ProfilesStore, ProfilesClient } from "../src/index.ts";

      import { onSubmit } from "@holochain-open-dev/elements";
      import "../src/elements/profiles-context.ts";
      import "../src/elements/profile-prompt.ts";
      import "../src/elements/agent-avatar.ts";
      import "../src/elements/agent-mention.ts";
      import "../src/elements/my-profile.ts";
      import "../src/elements/list-profiles.ts";
      import "../src/elements/search-agent.ts";
      import "../src/elements/search-agents.ts";
      import "../src/elements/textarea-with-mentions.ts";

      async function sendRequest(request) {
        return new Promise((resolve, reject) => {
          const channel = new MessageChannel();

          window.top.postMessage(request, "*", [channel.port2]);

          channel.port1.onmessage = (m) => {
            if (m.data.type === "success") {
              resolve(m.data.result);
            } else if (m.data.type === "error") {
              reject(m.data.error);
            }
          };
        });
      }

      class ProfilesTest extends LitElement {
        static get properties() {
          return {
            loaded: {
              type: Boolean,
            },
          };
        }

        async firstUpdated() {
          try {
            const appRuntimeInfo = await Promise.race([
              sendRequest({
                type: "get-app-runtime-info",
              }),
              new Promise((_resolve, reject) =>
                setTimeout(() => reject(new Error("")), 1000)
              ),
            ]);

            this._client = await AppAgentWebsocket.connect(
              new URL(`ws://localhost:${appRuntimeInfo.runtimeInfo.app_port}`),
              appRuntimeInfo.appId,
              60000
            );

            const appWs = this._client.appWebsocket;
            appWs.callZome = appWs._requester("call_zome", {
              input: async (request) => {
                if ("signature" in request) {
                  return request;
                }

                return sendRequest({
                  type: "sign-zome-call",
                  zomeCall: request,
                });
              },
              output: (response) => decode(response),
            });
          } catch (e) {
            // await setLocale();
            // console.log('we are in the normal launcher env');
            this._client = await AppAgentWebsocket.connect(
              new URL(`ws://localhost`),
              "test-app",
              60000
            );
          }

          const service = new ProfilesClient(this._client, "profiles-test");

          this.store = new ProfilesStore(service, {
            avatarMode: "avatar-required",
            additionalFields: [
              {
                name: "location",
                label: "Location",
                required: true,
              },
              {
                name: "bio",
                label: "Bio",
                required: false,
              },
            ],
          });
          this.loaded = true;
        }

        onSubmit(f) {
          console.log(f);
          this.shadowRoot.querySelector("form").reset();
          setTimeout(() => {
            this.shadowRoot.querySelector("textarea-with-mentions").value =
              f.hi;
          }, 400);
        }

        render() {
          if (!this.loaded) return html`<span>Loading...</span>`;
          return html`
            <profiles-context .store=${this.store}>
              <profile-prompt
                style="align-items: start"
                @profile-created=${(e) => console.log(e)}
              >
                <form ${onSubmit((f) => this.onSubmit(f))}>
                  <textarea-with-mentions
                    name="hi"
                    label="hey"
                  ></textarea-with-mentions>
                  <input type="submit" />
                </form>
                <list-profiles></list-profiles>
                <my-profile style="height: 800px; width: 800px;"></my-profile>
                <agent-avatar .agentPubKey=${this.store.client.client.myPubKey}>
                  <div
                    style="background-color: lightgreen; width: 12px; height: 12px; border-radius: 50%"
                    slot="badge"
                  ></div>
                </agent-avatar>
                <search-agent
                  name="author"
                  required
                  include-myself
                  @agent-selected=${(e) => console.log(e)}
                ></search-agent>
                <search-agents
                  name="hosts"
                  required
                  include-myself
                ></search-agents>
                <agent-avatar
                  .agentPubKey=${this.store.client.client.myPubKey}
                  .showOnHover=${false}
                  .copyOnClick=${false}
                >
                </agent-avatar>
                <agent-mention
                  .agentPubKey=${this.store.client.client.myPubKey}
                >
                </agent-mention>
              </profile-prompt>
            </profiles-context>
          `;
        }
      }

      customElements.define("profiles-test", ProfilesTest);
    </script>
  </body>
</html>
